import CustomPostButton from "@/components/custom-post-button";
import Feed from "@/components/feed";
import { getUserData } from "@/utils/supabase/server/helpers";
import { createClient } from "@/utils/supabase/server";
import { redirect } from "next/navigation";

export default async function FeedPage() {
  const supabase = await createClient();
  const userData = await getUserData();

  const { data: agents } = await supabase
    .from("agents")
    .select("*")
    .eq("team", userData?.team || 0);

  if (!userData?.team) {
    redirect("/team-creation");
  }

  if (!agents || agents.length === 0) {
    return (
      <div className="w-full flex items-center justify-center min-h-screen">
        <div className="text-center animate-fade-in">
          <svg
            width="141"
            height="140"
            viewBox="0 0 141 140"
            fill="none"
            className="mx-auto mb-4"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M0.347656 22C0.347656 9.84974 10.1974 0 22.3477 0H118.348C130.498 0 140.348 9.84974 140.348 22V118C140.348 130.15 130.498 140 118.348 140H22.3477C10.1974 140 0.347656 130.15 0.347656 118V22Z"
              fill="url(#paint0_linear_431_8190)"
              fillOpacity="0.18"
            />
            <path
              d="M0.847656 22C0.847656 10.1259 10.4735 0.5 22.3477 0.5H118.348C130.222 0.5 139.848 10.1259 139.848 22V118C139.848 129.874 130.222 139.5 118.348 139.5H22.3477C10.4735 139.5 0.847656 129.874 0.847656 118V22Z"
              stroke="white"
              strokeOpacity="0.08"
            />
            <rect
              width="52.7354"
              height="32.2412"
              rx="6"
              transform="matrix(1 0 0 -1 71.4453 64.8008)"
              fill="white"
              fillOpacity="0.48"
            />
            <rect
              x="16.5146"
              y="90.5957"
              width="46.5322"
              height="7.83367"
              rx="3.91683"
              fill="white"
              fillOpacity="0.48"
            />
            <rect
              x="16.5146"
              y="101.681"
              width="46.5322"
              height="7.83367"
              rx="3.91683"
              fill="white"
              fillOpacity="0.48"
            />
            <rect
              x="16.5146"
              y="112.765"
              width="32.0879"
              height="7.83367"
              rx="3.91683"
              fill="white"
              fillOpacity="0.48"
            />
            <path
              fill-rule="evenodd"
              clip-rule="evenodd"
              d="M99.4654 112.388L110.804 108.596C112.541 107.989 112.541 105.667 110.804 105.06L99.4654 100.08C99.0268 99.8933 98.6059 98.6447 98.3522 97.8929C98.2902 97.7086 98.2379 97.5537 98.1981 97.4521L93.6488 85.2347C93.0059 83.5936 90.5484 83.5936 89.9055 85.2347L85.2681 97.4521C85.2352 97.536 85.192 97.6571 85.1404 97.8018C84.8745 98.5472 84.3846 99.92 83.9272 100.08L72.7484 105.06C71.0109 105.667 71.0109 107.989 72.7484 108.596L84.089 112.388C84.5306 112.542 84.8966 113.621 85.1275 114.301C85.1822 114.463 85.2294 114.601 85.2681 114.7L89.9055 125.959C90.5484 127.601 93.0059 127.601 93.6488 125.959L98.2863 114.7C98.3249 114.601 98.3721 114.463 98.4268 114.301C98.6576 113.621 99.0239 112.542 99.4654 112.388ZM93.8639 112.934C93.8708 112.912 93.8957 112.838 93.9815 112.587C94.0655 112.342 94.1934 111.974 94.3513 111.59C94.497 111.235 94.7403 110.686 95.0973 110.136C95.2796 109.855 95.557 109.471 95.9482 109.088C96.3279 108.715 96.973 108.187 97.9059 107.861L97.9361 107.851L102.654 106.408L97.5754 104.477C96.6453 104.072 96.0427 103.479 95.731 103.132C95.3872 102.748 95.1419 102.371 94.9813 102.101C94.663 101.564 94.432 101.02 94.2847 100.648C94.1265 100.249 93.9939 99.8646 93.903 99.5966C93.7791 99.231 93.7697 99.2018 93.7731 99.2107L93.7583 99.1728L91.7525 93.7859L89.7024 99.1869L89.693 99.2107C89.6975 99.1992 89.689 99.221 89.6498 99.3305C89.6417 99.353 89.632 99.3801 89.6213 99.4103C89.5924 99.4911 89.5557 99.5942 89.5194 99.6944C89.4168 99.978 89.2718 100.369 89.0997 100.774C88.9403 101.149 88.6916 101.695 88.3546 102.229C88.1854 102.498 87.9227 102.878 87.5544 103.262C87.2529 103.576 86.6666 104.121 85.7787 104.494L81.1272 106.408L85.6182 107.851L85.6485 107.861C86.5815 108.187 87.2265 108.715 87.6062 109.088C87.9973 109.471 88.2747 109.855 88.457 110.136C88.8141 110.686 89.0573 111.235 89.2031 111.59C89.361 111.974 89.4888 112.342 89.5729 112.587C89.6587 112.838 89.6836 112.912 89.6905 112.934L91.7772 118L93.8639 112.934Z"
              fill="white"
              fillOpacity="0.48"
            />
            <path
              d="M120.757 94.8138C120.398 94.9889 120.059 95.2023 119.745 95.4505C119.604 95.562 119.468 95.6805 119.338 95.8057C119.31 95.8324 119.283 95.8593 119.256 95.8866C119.229 95.9137 119.202 95.9411 119.175 95.9687C119.051 96.0981 118.934 96.233 118.824 96.373C118.574 96.6902 118.359 97.0337 118.183 97.3964C118.015 97.7429 117.882 98.1075 117.788 98.4846L117.543 99.466C117.344 100.263 116.629 100.822 115.809 100.822C114.989 100.822 114.275 100.263 114.076 99.466L113.831 98.4846C113.737 98.1075 113.604 97.7425 113.436 97.3959C113.26 97.0331 113.045 96.69 112.795 96.3727C112.684 96.2328 112.567 96.098 112.443 95.9687C112.417 95.9411 112.39 95.9137 112.363 95.8866C112.336 95.8593 112.309 95.8324 112.281 95.8057C112.151 95.6805 112.015 95.562 111.874 95.4505C111.561 95.203 111.222 94.9901 110.865 94.8152L110.861 94.8136C110.514 94.6439 110.149 94.5102 109.771 94.4155L108.792 94.1701C107.996 93.9708 107.438 93.2545 107.438 92.4327C107.438 91.6109 107.996 90.8946 108.792 90.6953L109.771 90.4499C110.149 90.3549 110.515 90.2207 110.862 90.0508C111.22 89.8755 111.559 89.6619 111.873 89.4136C112.014 89.3022 112.15 89.1838 112.279 89.0587C112.307 89.0322 112.334 89.0053 112.361 88.9782C112.389 88.9509 112.416 88.9233 112.442 88.8955C112.566 88.7663 112.683 88.6315 112.793 88.4916C113.043 88.1749 113.258 87.8319 113.433 87.4697C113.601 87.123 113.734 86.7582 113.828 86.3809L114.074 85.3983C114.274 84.6015 114.989 84.0429 115.809 84.0429C116.629 84.0429 117.344 84.6025 117.543 85.4003L117.788 86.3809C117.882 86.7581 118.015 87.1228 118.183 87.4695L118.186 87.4757C118.361 87.8361 118.575 88.177 118.824 88.4924C118.934 88.6323 119.051 88.7673 119.175 88.8966C119.202 88.9243 119.229 88.9517 119.256 88.9788C119.283 89.0059 119.31 89.0326 119.337 89.059C119.467 89.1838 119.603 89.302 119.743 89.4132C120.058 89.6621 120.398 89.8763 120.757 90.0518C121.105 90.2214 121.47 90.3552 121.848 90.4499L122.827 90.6953C123.623 90.8946 124.181 91.6109 124.181 92.4327C124.181 93.2545 123.623 93.9708 122.827 94.1701L121.848 94.4155C121.47 94.5102 121.104 94.6442 120.757 94.8138Z"
              fill="white"
              fillOpacity="0.48"
            />
            <path
              fill-rule="evenodd"
              clip-rule="evenodd"
              d="M39.3433 23.3468C37.9397 23.3468 36.8018 24.4847 36.8018 25.8883C36.8018 27.292 37.9397 28.4299 39.3433 28.4299C40.747 28.4299 41.8849 27.292 41.8849 25.8883C41.8849 24.4847 40.747 23.3468 39.3433 23.3468ZM31.7284 25.8883C31.7284 21.6827 35.1377 18.2734 39.3433 18.2734C43.5489 18.2734 46.9582 21.6827 46.9582 25.8883C46.9582 29.2031 44.8403 32.0231 41.8839 33.0691L41.8839 36.8853H52.0281C57.632 36.8853 62.1748 41.4282 62.1748 47.032V59.7154C62.1748 65.3193 57.632 69.8621 52.0281 69.8621H26.6613C21.0575 69.8621 16.5146 65.3193 16.5146 59.7154V47.032C16.5146 41.4282 21.0575 36.8853 26.6614 36.8853H36.8106V33.0719C33.8501 32.0281 31.7284 29.206 31.7284 25.8883ZM26.6614 41.9587H52.0281C54.83 41.9587 57.1015 44.2301 57.1015 47.032V59.7154C57.1015 62.5173 54.83 64.7888 52.0281 64.7888H26.6613C23.8594 64.7888 21.588 62.5173 21.588 59.7154V47.032C21.588 44.2301 23.8594 41.9587 26.6614 41.9587ZM46.4883 52.0515C47.8893 52.0515 49.025 50.9158 49.025 49.5148C49.025 48.1138 47.8893 46.9781 46.4883 46.9781C45.0873 46.9781 43.9516 48.1138 43.9516 49.5148C43.9516 50.9158 45.0873 52.0515 46.4883 52.0515ZM34.5999 49.5148C34.5999 50.9158 33.4642 52.0515 32.0632 52.0515C30.6623 52.0515 29.5266 50.9158 29.5266 49.5148C29.5266 48.1138 30.6623 46.9781 32.0632 46.9781C33.4642 46.9781 34.5999 48.1138 34.5999 49.5148ZM43.8961 54.5881C45.5466 54.5881 46.9369 55.9755 46.3053 57.5004C45.9228 58.4237 45.3623 59.2626 44.6556 59.9692C43.949 60.6759 43.1101 61.2365 42.1868 61.6189C41.2635 62.0013 40.2739 62.1982 39.2745 62.1982C38.2752 62.1982 37.2856 62.0013 36.3623 61.6189C35.439 61.2365 34.6001 60.6759 33.8934 59.9692C33.1868 59.2626 32.6262 58.4237 32.2438 57.5004C31.6122 55.9755 33.0025 54.5881 34.6529 54.5881H43.8961Z"
              fill="white"
              fillOpacity="0.48"
            />
            <defs>
              <linearGradient
                id="paint0_linear_431_8190"
                x1="70.3477"
                y1="0"
                x2="70.3477"
                y2="140"
                gradientUnits="userSpaceOnUse"
              >
                <stop stop-color="white" />
                <stop offset="1" stop-color="white" stop-opacity="0.18" />
              </linearGradient>
            </defs>
          </svg>

          <h2 className="text-2xl font-semibold text-gray-700 dark:text-gray-300 mb-2">
            No Agents Found
          </h2>
          <p className="text-gray-500 dark:text-gray-400">
            Create an agent to get started with your feed
          </p>
        </div>
      </div>
    );
  }

  return (
    <>
      <CustomPostButton agents={agents} />
      {/* TODO: Add way to select active agent - and/or pin agent to the homepage */}
      <Feed teamId={userData?.team || 0} agentId={agents?.[0]?.id || 0} />
    </>
  );
}
